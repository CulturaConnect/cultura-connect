name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Permite executar manualmente

env:
  NODE_VERSION: '22'

jobs:
  test:
    runs-on: ubuntu-latest
    name: Test & Build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests (se houver)
      run: npm run test --if-present || echo "Nenhum teste configurado"

    - name: Type check
      run: npx tsc --noEmit

    - name: Build project
      run: npm run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: dist/

  deploy:
    needs: test
    runs-on: ubuntu-latest
    name: Deploy to VPS
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        command_timeout: 300s
        script: |
          # Cores para output
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          BLUE='\033[0;34m'
          NC='\033[0m' # No Color
          
          echo -e "${BLUE}üöÄ Iniciando deploy automatizado...${NC}"
          
          # Vari√°veis de configura√ß√£o
          PROJECT_PATH="${{ secrets.VPS_PROJECT_PATH }}"
          BACKUP_PATH="${{ secrets.VPS_BACKUP_PATH || '/tmp/cultura-connect-backups' }}"
          
          # Criar diret√≥rio de backup se n√£o existir
          mkdir -p "$BACKUP_PATH"
          
          # Verificar se o diret√≥rio do projeto existe
          if [ ! -d "$PROJECT_PATH" ]; then
            echo -e "${RED}‚ùå Diret√≥rio do projeto n√£o encontrado: $PROJECT_PATH${NC}"
            exit 1
          fi
          
          cd "$PROJECT_PATH"
          echo -e "${BLUE}üìÅ Diret√≥rio atual: $(pwd)${NC}"
          
          # Fazer backup da build atual
          if [ -d "dist" ]; then
            BACKUP_NAME="dist_backup_$(date +%Y%m%d_%H%M%S)"
            echo -e "${YELLOW}üì¶ Fazendo backup: $BACKUP_NAME${NC}"
            cp -r dist "$BACKUP_PATH/$BACKUP_NAME" || echo -e "${YELLOW}‚ö†Ô∏è  Backup falhou, continuando...${NC}"
            
            # Limpar backups antigos (manter apenas os 5 mais recentes)
            cd "$BACKUP_PATH"
            ls -t | grep "dist_backup_" | tail -n +6 | xargs -r rm -rf || true
            cd "$PROJECT_PATH"
          fi
          
          # Verificar status do git
          echo -e "${BLUE}üì• Verificando reposit√≥rio...${NC}"
          git fetch origin
          
          # Fazer pull das mudan√ßas
          echo -e "${BLUE}üì• Fazendo pull do reposit√≥rio...${NC}"
          git reset --hard origin/main
          
          # Verificar se package.json mudou
          if git diff HEAD~1 --name-only | grep -q "package.json\|package-lock.json" || [ ! -d "node_modules" ]; then
            echo -e "${YELLOW}üì¶ Instalando/atualizando depend√™ncias...${NC}"
            npm ci --only=production
          else
            echo -e "${GREEN}üì¶ Depend√™ncias j√° est√£o atualizadas${NC}"
          fi
          
          # Fazer build do projeto
          echo -e "${BLUE}üî® Fazendo build do projeto...${NC}"
          NODE_ENV=production npm run build
          
          # Verificar se o build foi bem-sucedido
          if [ ! -d "dist" ] || [ -z "$(ls -A dist)" ]; then
            echo -e "${RED}‚ùå Build falhou ou diret√≥rio dist est√° vazio!${NC}"
            exit 1
          fi
          
          # Definir permiss√µes corretas
          echo -e "${BLUE}üîê Configurando permiss√µes...${NC}"
          chmod -R 755 dist/ || true
          
          # Reiniciar servi√ßos (descomente conforme necess√°rio)
          echo -e "${BLUE}üîÑ Reiniciando servi√ßos...${NC}"
          
          # Para Nginx
          # sudo systemctl reload nginx && echo -e "${GREEN}‚úÖ Nginx recarregado${NC}" || echo -e "${YELLOW}‚ö†Ô∏è Erro ao recarregar Nginx${NC}"
          
          # Para PM2
          # pm2 restart all && echo -e "${GREEN}‚úÖ PM2 reiniciado${NC}" || echo -e "${YELLOW}‚ö†Ô∏è Erro ao reiniciar PM2${NC}"
          
          # Para Apache
          # sudo systemctl reload apache2 && echo -e "${GREEN}‚úÖ Apache recarregado${NC}" || echo -e "${YELLOW}‚ö†Ô∏è Erro ao recarregar Apache${NC}"
          
          # Para Docker
          # docker-compose restart web && echo -e "${GREEN}‚úÖ Docker reiniciado${NC}" || echo -e "${YELLOW}‚ö†Ô∏è Erro ao reiniciar Docker${NC}"
          
          echo -e "${GREEN}üéâ Deploy conclu√≠do com sucesso!${NC}"
          echo -e "${BLUE}üìä Estat√≠sticas do build:${NC}"
          echo "   - Tamanho do dist: $(du -sh dist | cut -f1)"
          echo "   - Arquivos: $(find dist -type f | wc -l) arquivos"
          echo "   - Data: $(date)"
          echo "   - Commit: $(git rev-parse --short HEAD)"
          echo "   - Branch: $(git branch --show-current)"

    - name: Notify success
      if: success()
      run: |
        echo "‚úÖ Deploy realizado com sucesso na VPS!"
        echo "üîó Commit: ${{ github.sha }}"
        echo "üë§ Autor: ${{ github.actor }}"

    - name: Notify failure
      if: failure()
      run: |
        echo "‚ùå Deploy falhou!"
        echo "üîó Verifique os logs acima para mais detalhes"